<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plataforma UniPsi | Rede Profissional</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<style>
  :root {
    --primary-color: #005b96;
    --secondary-color: #00a896;
    --bg-light: #f4f7f6;
    --text-dark: #333;
    --danger: #e74c3c;
    --success: #2ecc71;
    --warning: #f39c12;
    --info: #3498db;
    --super: #8e44ad;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Roboto', sans-serif; background-color: var(--bg-light); color: var(--text-dark); line-height: 1.6; }

  /* Header */
  header { background: white; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
  .logo-container { display: flex; align-items: center; gap: 15px; }
  .logo-svg { width: 45px; height: 45px; fill: var(--primary-color); }
  .brand-name { font-family: 'Montserrat', sans-serif; font-size: 1.4rem; font-weight: 700; color: var(--primary-color); }
  .brand-tagline { font-size: 0.8rem; color: #666; }

  /* Nav */
  .nav-tabs { display: flex; gap: 5px; margin-top: 1rem; flex-wrap: wrap; }
  .nav-btn { background: none; border: none; padding: 10px 15px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; font-size: 0.9rem; }
  .nav-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
  .nav-btn:hover { color: var(--primary-color); }
  
  .auth-hidden { display: none !important; }

  /* Main */
  main { max-width: 1100px; margin: 30px auto; padding: 0 20px; min-height: 75vh; }
  .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); display: none; animation: fadeIn 0.4s ease-in-out; }
  .card.active-view { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Inputs & Forms */
  .form-group { margin-bottom: 15px; }
  label { display: block; margin-bottom: 8px; font-weight: 500; }
  input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; font-family: inherit; }
  input:focus, textarea:focus { outline: none; border-color: var(--primary-color); }
  input[readonly] { background-color: #eee; cursor: not-allowed; }

  /* Buttons */
  .btn { padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; width: 100%; transition: 0.2s; text-align: center; text-decoration: none; display: inline-block; }
  .btn-primary { background-color: var(--primary-color); } .btn-primary:hover { background-color: #004a7a; }
  .btn-secondary { background-color: var(--secondary-color); }
  .btn-danger { background-color: var(--danger); width: auto; padding: 8px 16px; }
  .btn-warning { background-color: var(--warning); color:white;}
  .btn-info { background-color: var(--info); color: white; }
  .btn-super { background-color: var(--super); color: white; } 
  .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; width: auto; padding: 8px 12px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px;}
  .btn-outline:hover { background: #f0f0f0; }

  /* Badges e Status */
  .badge { padding: 5px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
  .badge-pendente { background: #fff3cd; color: #856404; }
  .badge-aprovado { background: #d4edda; color: #155724; }
  .badge-rejeitado { background: #f8d7da; color: #721c24; }
  .badge-adm { background: #cce5ff; color: #004085; }
  .badge-super { background: #e8daef; color: #5b2c6f; border: 1px solid #d2b4de; }

  /* Rede Social - LinkedIn Style */
  .social-post { border-bottom: 1px solid #eee; padding: 20px 0; }
  .post-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
  .post-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; }
  .post-author { font-weight: 700; color: var(--primary-color); font-size: 1rem; }
  .post-role { font-size: 0.75rem; color: #666; display: block; }
  .post-content { margin-bottom: 15px; color: #333; white-space: pre-wrap; font-size: 0.95rem; }
  .post-media { margin-top: 10px; position: relative; display: inline-block; max-width: 100%; }
  .post-media img, .post-media video { max-width: 100%; border-radius: 8px; max-height: 400px; object-fit: contain; background: #000; display: block; }
  
  .post-actions { display: flex; gap: 20px; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; flex-wrap: wrap; }
  .action-btn { background: none; border: none; cursor: pointer; color: #666; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; font-weight: 600; padding: 5px 10px; border-radius: 4px; transition: 0.2s;}
  .action-btn:hover { background: #f0f2f5; color: var(--primary-color); }
  .action-btn.liked { color: var(--danger); }
   
  .comment-section { background: #f0f2f5; padding: 15px; border-radius: 8px; margin-top: 10px; display: none; }
  .comment-item { border-bottom: 1px solid #e0e0e0; padding: 8px 0; font-size: 0.9rem; }

  /* √Årea de Criar Post e Previews */
  .create-post-box { background:#fff; padding:20px; border-radius:10px; margin-bottom:30px; border:1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .cp-header { display: flex; gap: 10px; margin-bottom: 15px; }
  .cp-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  .cp-input { width: 100%; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; resize: none; min-height: 50px; font-family: inherit; }
  
  .media-preview-container { position: relative; display: inline-block; margin-top: 10px; display: none; }
  .media-preview { max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ccc; object-fit: cover; }
  .btn-remove-media { position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }

  .cp-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
  .loading-bar { display: none; width: 100%; height: 4px; background: #eee; margin-top: 10px; border-radius: 2px; overflow: hidden; }
  .loading-fill { height: 100%; background: var(--primary-color); width: 0%; animation: load 2s infinite; }
  @keyframes load { 0% { width: 0%; } 50% { width: 70%; } 100% { width: 100%; } }

  /* Modal de Edi√ß√£o */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
  .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
  
  /* Loja / Recursos */
  .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
  .product-card { border: 1px solid #eee; border-radius: 10px; overflow: hidden; background: white; transition: 0.3s; position: relative; }
  .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
  .product-img { width: 100%; height: 150px; object-fit: cover; background: #eee; }
  .product-body { padding: 15px; }
  .product-title { font-weight: 700; margin-bottom: 5px; color: var(--text-dark); }
  .product-price { color: var(--success); font-weight: 700; font-size: 1.1rem; margin-bottom: 10px; }
  .product-desc { font-size: 0.85rem; color: #666; margin-bottom: 15px; height: 40px; overflow: hidden; }

  /* Utilit√°rios */
  .alert { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; text-align: center; }
  .alert-error { background: #f8d7da; color: #721c24; }
  .hidden { display: none !important; }
  table { width: 100%; border-collapse: collapse; min-width: 600px; }
  th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
  th { background-color: #f8f9fa; color: var(--primary-color); }
  .table-container { overflow-x: auto; margin-top: 10px; margin-bottom: 30px;}

  footer { text-align: center; padding: 25px; font-size: 0.85rem; color: #888; border-top: 1px solid #eee; margin-top: 40px; }
</style>
</head>
<body oncontextmenu="return false;">

<header>
  <div class="logo-container">
    <svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 2c1.66 0 3 1.34 3 3v3h2V7c0-2.76-2.24-5-5-5S7 4.24 7 7v3h2V7c0-1.66 1.34-3 3-3zm3 11v2h-2v-2h-2v2H9v-2H7v4h10v-4h-2z"/>
    </svg>
    <div>
        <div class="brand-name">Plataforma UniPsi</div>
        <div class="brand-tagline">Rede Profissional Conectada</div>
    </div>
  </div>
  <nav class="nav-tabs auth-hidden" id="mainNav">
    <button class="nav-btn active" id="btn-social">Feed Profissional</button>
    <button class="nav-btn" id="btn-perfil">Meu Perfil</button>
    <button class="nav-btn" id="btn-recursos">Recursos & Loja</button>
    <button class="nav-btn" id="btn-staff">Junte-se √† Equipe</button>
    <button class="nav-btn" id="btn-admin">Painel do Gestor</button>
    <button class="nav-btn" id="btn-sair" style="color:var(--danger)">Sair</button>
  </nav>
</header>

<main>
  <section id="loginView" class="card active-view" style="max-width: 500px; margin: 50px auto;">
    <h2 style="text-align: center; color: var(--primary-color);">Bem-vindo(a), Psi!</h2>
    <p style="text-align: center; color: #666; margin-bottom: 25px;">Fa√ßa login com seu CRP para acessar a rede.</p>
    
    <div id="loginAlert" class="alert alert-error"></div>

    <form id="loginForm">
        <div class="form-group">
            <label>CRP (Ex: 00/00000)</label>
            <input type="text" id="loginCrp" placeholder="Digite seu CRP" required class="mask-crp">
        </div>
        <div class="form-group">
            <label>Senha</label>
            <input type="password" id="loginSenha" placeholder="Sua senha segura" required>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-bottom: 15px;">Entrar na Rede</button>
        <div style="text-align: center;">
            <a href="#" id="linkCadastro" style="color: var(--secondary-color); font-weight: bold; text-decoration: none;">N√£o tem conta? Cadastre-se aqui.</a>
        </div>
    </form>
  </section>

  <section id="inscricaoView" class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Nova Inscri√ß√£o Profissional</h2>
        <button id="btnVoltarLogin" class="btn btn-secondary" style="width: auto;">Voltar ao Login</button>
    </div>
    <p style="margin-bottom: 20px; font-size: 0.9rem; color: #666;">Seus dados ser√£o analisados. O prefixo "Psi." ser√° adicionado automaticamente.</p>
    
    <form id="inscriptionForm">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group"><label>Nome Completo</label><input type="text" id="nome" required placeholder="Ex: Macs Wellison"></div>
          <div class="form-group"><label>E-mail</label><input type="email" id="email" required placeholder="email@exemplo.com"></div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group"><label>WhatsApp</label><input type="text" id="whatsapp" required placeholder="(XX) XXXXX-XXXX" class="mask-tel"></div>
          <div class="form-group"><label>CRP (Usu√°rio)</label><input type="text" id="crp" required placeholder="XX/XXXXX" class="mask-crp"></div>
      </div>
      <div class="form-group"><label>Senha de Acesso</label><input type="password" id="senhaCadastro" required placeholder="Crie uma senha para entrar"></div>
      
      <div class="form-group"><label>Abordagem Cl√≠nica</label><input type="text" id="abordagem" placeholder="Ex: TCC, Psican√°lise..."></div>
      <div class="form-group"><label>Especialidades</label><textarea id="especialidades" rows="2" placeholder="Separe por v√≠rgula..."></textarea></div>
      <div class="form-group"><label>Foto de Perfil</label><input type="file" id="fotoFile" accept="image/*"></div>
      <button type="submit" class="btn btn-primary">Criar Conta Profissional</button>
    </form>
  </section>

  <section id="profileView" class="card">
    <h2>Meu Perfil Profissional</h2>
    <p style="color:#666; margin-bottom:20px;">Atualize suas informa√ß√µes vis√≠veis na rede.</p>
    <form id="profileForm">
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="profilePreview" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #eee;">
        </div>
        <div class="form-group"><label>Alterar Foto</label><input type="file" id="profileFotoFile" accept="image/*"></div>
        <div class="form-group"><label>Nome (Inalter√°vel)</label><input type="text" id="profileNome" readonly></div>
        <div class="form-group"><label>CRP (Inalter√°vel)</label><input type="text" id="profileCrp" readonly></div>
        <div class="form-group"><label>Abordagem Cl√≠nica</label><input type="text" id="profileAbordagem"></div>
        <div class="form-group"><label>Especialidades</label><textarea id="profileEspecialidades" rows="2"></textarea></div>
        <button type="submit" class="btn btn-secondary">Salvar Altera√ß√µes</button>
    </form>
  </section>

  <section id="socialView" class="card">
    <h2>Comunidade Profissional</h2>
    <p style="color:#666; margin-bottom:20px;">Interaja, compartilhe e conecte-se com colegas.</p>

    <div class="create-post-box">
        <div class="cp-header">
            <img id="userAvatarPost" src="https://via.placeholder.com/40" class="cp-avatar">
            <div style="width: 100%;">
                <textarea id="textoPost" class="cp-input" placeholder="Come√ßar publica√ß√£o... (M√≠dia, Artigo, D√∫vida)"></textarea>
                
                <div id="mediaPreviewContainer" class="media-preview-container">
                    <button type="button" class="btn-remove-media" id="btnRemoveMedia">X</button>
                    <img id="previewMedia" class="media-preview">
                </div>

                <div id="postLoading" class="loading-bar"><div class="loading-fill"></div></div>
            </div>
        </div>
        <div class="cp-actions">
            <div style="display: flex; gap: 10px;">
                <input type="file" id="midiaFile" accept="image/*,video/*" style="display: none;">
                <button type="button" class="btn-outline" onclick="document.getElementById('midiaFile').click()">
                    üì∑ Foto / üé• V√≠deo
                </button>
            </div>
            <button id="btnPublicar" class="btn btn-primary" style="width:auto; padding: 8px 25px;">Publicar</button>
        </div>
    </div>

    <h3 style="border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;">Feed de Atualiza√ß√µes</h3>
    <div id="feedContainer">
      <p style="text-align:center; color:#999;">Carregando feed profissional...</p>
    </div>

    <h3 style="border-bottom:2px solid #eee; padding-bottom:10px; margin:40px 0 20px;">Membros da Rede</h3>
    <input type="text" id="buscaMembro" placeholder="üîç Buscar profissional..." style="margin-bottom:20px;">
    <div class="store-grid" id="containerMembros"></div>
  </section>

  <section id="recursosView" class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Recursos & Loja UniPsi</h2>
        <button id="btnNovoProduto" class="btn btn-super hidden" style="width:auto;">+ Adicionar Produto</button>
    </div>
    <div id="formProduto" class="hidden" style="background:#f3e5f5; padding:20px; margin-bottom:20px; border-radius:8px;">
        <h4>Cadastrar Novo Produto</h4>
        <div class="form-group"><label>T√≠tulo</label><input type="text" id="prodTitulo"></div>
        <div class="form-group"><label>Descri√ß√£o Curta</label><input type="text" id="prodDesc"></div>
        <div class="form-group"><label>Valor (R$)</label><input type="text" id="prodValor" placeholder="Ex: 29,90 ou Gr√°tis"></div>
        <div class="form-group"><label>Link de Compra/Download</label><input type="text" id="prodLink"></div>
        <div class="form-group"><label>URL da Imagem</label><input type="text" id="prodImg" placeholder="https://..."></div>
        <button id="btnSalvarProduto" class="btn btn-super">Publicar Produto</button>
    </div>
    <div class="store-grid" id="lojaContainer"><p>Carregando produtos...</p></div>
  </section>

  <section id="staffRequestView" class="card">
    <h2>Candidatura para Administra√ß√£o</h2>
    <form id="staffForm">
        <div class="form-group"><label>Nome</label><input type="text" id="staffNome" required></div>
        <div class="form-group"><label>WhatsApp</label><input type="text" id="staffWhats" required class="mask-tel"></div>
        <div class="form-group"><label>Motivo</label><textarea id="staffMotivo" required></textarea></div>
        <button type="submit" class="btn btn-warning">Enviar Candidatura</button>
    </form>
  </section>

  <section id="adminView" class="card">
    <div id="adminDashboard">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:#f1f1f1; padding:15px; border-radius:8px;">
          <div><h3>Painel do Gestor</h3><small id="nivelAcesso" class="badge">Acesso Restrito</small></div>
      </div>
      <h4 class="admin-section-title">üë§ Gest√£o de Membros</h4>
      <div class="table-container">
        <table>
          <thead><tr><th>Profissional</th><th>Status</th><th>Cargo</th><th>A√ß√µes</th></tr></thead>
          <tbody id="tabelaInscritos"></tbody>
        </table>
      </div>
      <h4 class="admin-section-title" style="color:var(--warning)">üõ°Ô∏è Candidatos √† Staff</h4>
      <div class="table-container">
        <table>
            <thead><tr><th>Candidato</th><th>Motivo</th><th>A√ß√µes</th></tr></thead>
            <tbody id="tabelaStaff"></tbody>
          </table>
      </div>
    </div>
  </section>
</main>

<div id="editPostModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Editar Publica√ß√£o</h3>
        <input type="hidden" id="editPostId">
        <div class="form-group">
            <label>Texto</label>
            <textarea id="editPostText" rows="4"></textarea>
        </div>
        <div class="form-group">
            <label>M√≠dia Atual</label>
            <div id="editMediaContainer" style="position:relative; display:inline-block;">
                <img id="editMediaPreview" style="max-width:100%; max-height:200px; display:none; border-radius:6px;">
                <video id="editVideoPreview" controls style="max-width:100%; max-height:200px; display:none; border-radius:6px;"></video>
                <button type="button" id="btnRemoveEditMedia" style="display:none; position:absolute; top:5px; right:5px; background:red; color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer;">X</button>
                <p id="noMediaMsg" style="font-size:0.8rem; color:#888; display:none;">Nenhuma m√≠dia.</p>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:20px;">
             <button id="btnCancelEdit" class="btn btn-outline" style="width:auto;">Cancelar</button>
             <button id="btnSaveEdit" class="btn btn-primary" style="width:auto;">Salvar</button>
        </div>
    </div>
</div>

<footer>&copy; 2024 Plataforma UniPsi. Desenvolvido por Macs Wellison.</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove, update, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDSDDP98aln1BkuBzDaX7txziAp5CPEpD0",
    authDomain: "unipsi-792b6.firebaseapp.com",
    projectId: "unipsi-792b6",
    storageBucket: "unipsi-792b6.firebasestorage.app",
    messagingSenderId: "44741764168",
    appId: "1:44741764168:web:15ff9121ce50333dbd247d",
    measurementId: "G-HFSTGMGCQ3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const CONFIG = { linkGrupo: "https://chat.whatsapp.com/K77s3h51A7J6xvJW1TMxmk" };
  const MAX_FILE_SIZE = 500 * 1024 * 1024; // Limite de 3MB

  let userSession = null;
  let fotoBase64 = "";
  let midiaPostBase64 = "";
  let midiaPostType = "";
  let profileFotoBase64 = "";
  let editMediaRemoved = false; // Flag para edi√ß√£o

  const $ = (id) => document.getElementById(id);

  // --- 4. M√ÅSCARAS (Formata√ß√£o Autom√°tica) ---
  const mascaraTelefone = (v) => {
    v = v.replace(/\D/g,"");
    v = v.replace(/^(\d{2})(\d)/g,"($1) $2");
    v = v.replace(/(\d)(\d{4})$/,"$1-$2");
    return v.substring(0, 15);
  };

  const mascaraCRP = (v) => {
    v = v.replace(/\D/g,"");
    v = v.replace(/^(\d{2})(\d)/, "$1/$2");
    return v.substring(0, 8); // Limitando tamanho
  };

  // Aplicar m√°scaras a todos inputs com a classe
  document.querySelectorAll('.mask-tel').forEach(i => i.oninput = (e) => e.target.value = mascaraTelefone(e.target.value));
  document.querySelectorAll('.mask-crp').forEach(i => i.oninput = (e) => e.target.value = mascaraCRP(e.target.value));

  // --- ARQUIVOS ---
  $('fotoFile').addEventListener('change', (e) => processFile(e.target.files[0], (res) => fotoBase64 = res));
  $('profileFotoFile').addEventListener('change', (e) => processFile(e.target.files[0], (res) => profileFotoBase64 = res));
  
  $('midiaFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if(file) {
          if(file.size > MAX_FILE_SIZE) { alert("Arquivo muito grande! M√°ximo 3MB."); this.value = ""; return; }
          const reader = new FileReader();
          reader.onload = function() { 
              midiaPostBase64 = reader.result; 
              $('previewMedia').src = midiaPostBase64;
              $('mediaPreviewContainer').style.display = 'inline-block';
          };
          reader.readAsDataURL(file);
          midiaPostType = file.type.startsWith('video') ? 'video' : 'image';
      }
  });

  // Bot√£o remover m√≠dia na cria√ß√£o
  $('btnRemoveMedia').onclick = () => {
      midiaPostBase64 = "";
      $('midiaFile').value = "";
      $('mediaPreviewContainer').style.display = 'none';
  };

  function processFile(file, callback) {
      if(!file) return;
      if(file.size > MAX_FILE_SIZE) { alert("Arquivo muito grande! M√°ximo 3MB."); return; }
      const reader = new FileReader();
      reader.onload = () => callback(reader.result);
      reader.readAsDataURL(file);
  }

  // --- NAVEGA√á√ÉO ---
  function switchView(viewId) {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('active-view'));
      $(viewId).classList.add('active-view');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      if(viewId==='socialView') $('btn-social').classList.add('active');
      if(viewId==='profileView') $('btn-perfil').classList.add('active');
      if(viewId==='recursosView') $('btn-recursos').classList.add('active');
      if(viewId==='staffRequestView') $('btn-staff').classList.add('active');
      if(viewId==='adminView') $('btn-admin').classList.add('active');
  }

  $('btn-social').onclick = () => switchView('socialView');
  $('btn-perfil').onclick = () => { populateProfile(); switchView('profileView'); };
  $('btn-recursos').onclick = () => switchView('recursosView');
  $('btn-staff').onclick = () => switchView('staffRequestView');
  $('btn-admin').onclick = () => {
      if(userSession && (userSession.cargo === 'Admin' || userSession.cargo === 'Supervisor')) {
         switchView('adminView');
      } else { alert("Acesso negado."); }
  };
  $('btn-sair').onclick = () => { userSession = null; $('mainNav').classList.add('auth-hidden'); switchView('loginView'); $('loginForm').reset(); };
  $('linkCadastro').onclick = (e) => { e.preventDefault(); switchView('inscricaoView'); };
  $('btnVoltarLogin').onclick = () => switchView('loginView');

  // --- LOGIN & CADASTRO ---
  $('loginForm').onsubmit = (e) => {
      e.preventDefault();
      const crpInput = $('loginCrp').value.trim();
      const senhaInput = $('loginSenha').value.trim();
      get(query(ref(db, 'membros'), orderByChild('crp'), equalTo(crpInput))).then((snap) => {
          if (snap.exists()) {
              const dados = Object.values(snap.val())[0];
              const key = Object.keys(snap.val())[0];
              if(dados.senha === senhaInput) {
                  userSession = { ...dados, id: key };
                  iniciarSessao();
              } else { alert("Senha incorreta."); }
          } else { alert("CRP n√£o encontrado."); }
      });
  };

  function iniciarSessao() {
      switchView('socialView');
      $('mainNav').classList.remove('auth-hidden');
      $('userAvatarPost').src = userSession.foto || 'https://via.placeholder.com/40';
      if(userSession.cargo === 'Supervisor') {
          $('nivelAcesso').innerText = "SUPERVISOR"; $('nivelAcesso').className = "badge badge-super";
          $('btnNovoProduto').classList.remove('hidden');
      } else if (userSession.cargo === 'Admin') {
          $('nivelAcesso').innerText = "ADMINISTRADOR"; $('nivelAcesso').className = "badge badge-adm";
      } else {
          $('nivelAcesso').innerText = "MEMBRO"; $('nivelAcesso').className = "badge badge-pendente";
      }
  }

  $('inscriptionForm').onsubmit = (e) => {
      e.preventDefault();
      const nomePuro = $('nome').value;
      const nomeFormatado = nomePuro.toLowerCase().startsWith('psi.') ? nomePuro : `Psi. ${nomePuro}`;
      const crpVal = $('crp').value;
      
      get(query(ref(db, 'membros'), orderByChild('crp'), equalTo(crpVal))).then((snap) => {
          if(snap.exists()){ alert("CRP j√° cadastrado!"); } 
          else {
              push(ref(db, 'membros'), {
                  nome: nomeFormatado,
                  email: $('email').value,
                  whatsapp: $('whatsapp').value,
                  crp: crpVal,
                  senha: $('senhaCadastro').value,
                  abordagem: $('abordagem').value,
                  especialidades: $('especialidades').value.split(','),
                  foto: fotoBase64 || "",
                  status: "Pendente",
                  cargo: "Membro",
                  dataCadastro: new Date().toISOString()
              }).then(() => { alert("Cadastro realizado! Fa√ßa login."); $('inscriptionForm').reset(); switchView('loginView'); });
          }
      });
  };

  // --- 2. MEU PERFIL (NOVO) ---
  function populateProfile() {
      if(!userSession) return;
      $('profileNome').value = userSession.nome;
      $('profileCrp').value = userSession.crp;
      $('profileAbordagem').value = userSession.abordagem || "";
      $('profileEspecialidades').value = userSession.especialidades ? userSession.especialidades.join(',') : "";
      $('profilePreview').src = userSession.foto || 'https://via.placeholder.com/100';
  }

  $('profileForm').onsubmit = (e) => {
      e.preventDefault();
      const updates = {
          abordagem: $('profileAbordagem').value,
          especialidades: $('profileEspecialidades').value.split(','),
      };
      if(profileFotoBase64) updates.foto = profileFotoBase64;

      update(ref(db, `membros/${userSession.id}`), updates).then(() => {
          alert("Perfil atualizado!");
          userSession = { ...userSession, ...updates }; // Atualizar sess√£o local
      });
  };

  // --- 3. SOCIAL FEED ---
  $('btnPublicar').onclick = () => {
      if(!userSession) return alert("Sess√£o expirada.");
      const texto = $('textoPost').value;
      if(!texto && !midiaPostBase64) return alert("Escreva algo.");
      
      // Carregando...
      $('postLoading').style.display = 'block';
      $('btnPublicar').disabled = true;

      push(ref(db, 'posts'), {
          autor: userSession.nome,
          autorId: userSession.id,
          cargo: userSession.cargo,
          fotoAutor: userSession.foto,
          texto: texto,
          midia: midiaPostBase64,
          midiaTipo: midiaPostType,
          data: new Date().toLocaleString('pt-BR'),
          likes: {}
      }).then(() => {
          $('textoPost').value = "";
          $('midiaFile').value = "";
          midiaPostBase64 = "";
          $('mediaPreviewContainer').style.display = 'none';
          $('postLoading').style.display = 'none';
          $('btnPublicar').disabled = false;
      }).catch(err => {
          alert("Erro no upload. Tente uma imagem menor.");
          $('postLoading').style.display = 'none';
          $('btnPublicar').disabled = false;
      });
  };

  onValue(ref(db, 'posts'), (snapshot) => {
      const feed = $('feedContainer');
      feed.innerHTML = "";
      const posts = Object.entries(snapshot.val() || {}).map(([k, v]) => ({...v, id: k})).reverse();
      
      if(posts.length === 0) feed.innerHTML = "<p style='text-align:center; padding:20px;'>Nenhum post.</p>";

      posts.forEach(post => {
          const isMe = userSession && userSession.id === post.autorId;
          const isSuper = userSession && userSession.cargo === 'Supervisor';
          
          let actionButtons = "";
          // 1. Bot√£o Editar (S√≥ dono)
          if (isMe) {
             actionButtons += `<button class="action-btn btn-edit-post" data-id="${post.id}" data-txt="${encodeURIComponent(post.texto)}" data-midia="${post.midia||''}" data-tipo="${post.midiaTipo||''}" style="margin-left:auto;">‚úèÔ∏è Editar</button>`;
          }
          // 3. Bot√£o Excluir (Dono ou Supervisor)
          if (isMe || isSuper) {
             // Se n√£o for o dono (√© supervisor), adiciona margem autom√°tica para alinhar
             const style = !isMe ? "margin-left:auto; color:red" : "color:red";
             actionButtons += `<button class="action-btn btn-del-post" data-id="${post.id}" style="${style}">üóëÔ∏è</button>`;
          }

          let midiaHtml = "";
          if(post.midia) {
              if(post.midiaTipo === 'video') midiaHtml = `<div class="post-media"><video src="${post.midia}" controls></video></div>`;
              else midiaHtml = `<div class="post-media"><img src="${post.midia}"></div>`;
          }

          const likesCount = post.likes ? Object.keys(post.likes).length : 0;
          const userLiked = userSession && post.likes && post.likes[userSession.id];

          feed.innerHTML += `
          <div class="social-post">
              <div class="post-header">
                  <img src="${post.fotoAutor || 'https://via.placeholder.com/40'}" class="post-avatar">
                  <div>
                      <span class="post-author">${post.autor}</span>
                      <span class="post-role">${post.cargo}</span>
                      <div style="font-size:0.75rem; color:#999">${post.data}</div>
                  </div>
              </div>
              <div class="post-content">${post.texto}</div>
              ${midiaHtml}
              <div class="post-actions">
                  <button class="action-btn btn-like ${userLiked?'liked':''}" data-id="${post.id}">
                    ${userLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likesCount}
                  </button>
                  <button class="action-btn" onclick="document.getElementById('comment-box-${post.id}').style.display='block'">üí¨ Comentar</button>
                  ${actionButtons}
              </div>
              <div id="comment-box-${post.id}" class="comment-section">
                   <div style="margin-bottom:10px; max-height:100px; overflow-y:auto;">
                      ${post.comentarios ? Object.values(post.comentarios).map(c => `<div class="comment-item"><strong>${c.autor}:</strong> ${c.texto}</div>`).join('') : ''}
                   </div>
                   <div style="display:flex; gap:5px;">
                      <input type="text" id="input-c-${post.id}" placeholder="Comentar..." style="width:100%; border:1px solid #ddd; padding:8px; border-radius:20px;">
                      <button class="btn-primary btn-send-comment" data-id="${post.id}" style="width:auto; padding:5px 15px; border-radius:20px;">Enviar</button>
                   </div>
              </div>
          </div>`;
      });

      attachPostEvents();
  });

  function attachPostEvents() {
      // Like
      document.querySelectorAll('.btn-like').forEach(b => {
          b.onclick = () => {
              if(!userSession) return;
              const refLike = ref(db, `posts/${b.dataset.id}/likes/${userSession.id}`);
              get(refLike).then(s => s.exists() ? remove(refLike) : set(refLike, true));
          }
      });
      // Delete
      document.querySelectorAll('.btn-del-post').forEach(b => {
          b.onclick = () => { if(confirm("Apagar post?")) remove(ref(db, 'posts/' + b.dataset.id)); }
      });
      // Comentar
      document.querySelectorAll('.btn-send-comment').forEach(b => {
          b.onclick = () => {
              const txt = $(`input-c-${b.dataset.id}`).value;
              if(txt && userSession) push(ref(db, `posts/${b.dataset.id}/comentarios`), { autor: userSession.nome, texto: txt });
          }
      });
      // Editar (Abrir Modal)
      document.querySelectorAll('.btn-edit-post').forEach(b => {
          b.onclick = () => {
              const id = b.dataset.id;
              const texto = decodeURIComponent(b.dataset.txt);
              const midia = b.dataset.midia;
              const tipo = b.dataset.tipo;

              $('editPostId').value = id;
              $('editPostText').value = texto;
              editMediaRemoved = false;
              
              if(midia && midia !== "undefined") {
                  $('btnRemoveEditMedia').style.display = 'block';
                  $('noMediaMsg').style.display = 'none';
                  if(tipo === 'video') {
                      $('editVideoPreview').src = midia; $('editVideoPreview').style.display = 'block'; $('editMediaPreview').style.display = 'none';
                  } else {
                      $('editMediaPreview').src = midia; $('editMediaPreview').style.display = 'block'; $('editVideoPreview').style.display = 'none';
                  }
              } else {
                  clearEditMediaView();
              }
              
              $('editPostModal').style.display = 'flex';
          }
      });
  }

  // --- L√ìGICA DE EDI√á√ÉO ---
  $('btnCancelEdit').onclick = () => $('editPostModal').style.display = 'none';
  
  $('btnRemoveEditMedia').onclick = () => {
      editMediaRemoved = true;
      clearEditMediaView();
  };

  function clearEditMediaView() {
      $('editMediaPreview').style.display = 'none';
      $('editVideoPreview').style.display = 'none';
      $('btnRemoveEditMedia').style.display = 'none';
      $('noMediaMsg').style.display = 'block';
  }

  $('btnSaveEdit').onclick = () => {
      const id = $('editPostId').value;
      const novoTexto = $('editPostText').value;
      
      const updates = { texto: novoTexto };
      if(editMediaRemoved) {
          updates.midia = null;
          updates.midiaTipo = null;
      }
      
      update(ref(db, 'posts/'+id), updates).then(() => {
          $('editPostModal').style.display = 'none';
      });
  };

  // --- ADMINISTRA√á√ÉO ---
  onValue(ref(db, 'membros'), (snapshot) => {
      const tbM = $('tabelaInscritos');
      tbM.innerHTML = "";
      const lista = Object.entries(snapshot.val() || {}).map(([k, v]) => ({ ...v, id: k })).reverse();
      
      lista.forEach(p => {
          let acoes = "";
          if(userSession && (userSession.cargo === 'Admin' || userSession.cargo === 'Supervisor')) {
              if(p.status === 'Pendente') {
                 acoes += `<button class="btn-primary btn-aprovar" data-id="${p.id}" data-nome="${p.nome}" data-tel="${p.whatsapp}" style="padding:4px 8px; font-size:0.7rem;">OK</button> `;
                 acoes += `<button class="btn-danger btn-reprovar" data-id="${p.id}" style="padding:4px 8px; font-size:0.7rem;">X</button>`;
              } else if (userSession.cargo === 'Supervisor') {
                 // 3. Op√ß√£o de Excluir cadastro para o Gestor
                 acoes += `<button class="btn-danger btn-excluir" data-id="${p.id}" data-tipo="membros" style="padding:4px; font-size:0.7rem;">üóëÔ∏è Excluir</button>`;
              }
          }
          tbM.innerHTML += `<tr><td><strong>${p.nome}</strong><br>${p.crp}</td><td><span class="badge ${p.status==='Aprovado'?'badge-aprovado':'badge-pendente'}">${p.status}</span></td><td>${p.cargo}</td><td>${acoes}</td></tr>`;
      });
      attachAdminListeners();
      renderSocialMembers(lista);
  });

  function renderSocialMembers(lista) {
      const grid = $('containerMembros');
      grid.innerHTML = "";
      lista.filter(m => m.status === 'Aprovado').forEach(p => {
          grid.innerHTML += `<div class="product-card" style="padding:15px; text-align:center;">
             <img src="${p.foto || 'https://via.placeholder.com/80'}" style="width:70px; height:70px; border-radius:50%; object-fit:cover; margin:0 auto 10px;">
             <div style="font-weight:bold; color:var(--primary-color)">${p.nome}</div>
             <div style="font-size:0.8rem; margin-bottom:10px;">${p.especialidades ? p.especialidades[0] : 'Psicologia'}</div>
             <a href="https://wa.me/55${p.whatsapp.replace(/\D/g,'')}" target="_blank" class="btn btn-secondary" style="padding:5px; font-size:0.8rem;">Conversar</a>
          </div>`;
      });
  }

  function attachAdminListeners() {
      document.querySelectorAll('.btn-aprovar').forEach(b => b.onclick = () => {
          update(ref(db, 'membros/'+b.dataset.id), { status: 'Aprovado' });
          const url = `https://wa.me/55${b.dataset.tel.replace(/\D/g,'')}?text=${encodeURIComponent("Ol√°! Sua inscri√ß√£o na UniPsi foi aprovada.")}`;
          window.open(url, '_blank');
      });
      document.querySelectorAll('.btn-reprovar').forEach(b => b.onclick = () => update(ref(db, 'membros/'+b.dataset.id), { status: 'Rejeitado' }));
      document.querySelectorAll('.btn-excluir').forEach(b => b.onclick = () => {
          if(confirm("Excluir cadastro definitivamente?")) remove(ref(db, b.dataset.tipo + '/' + b.dataset.id));
      });
  }

  // Loja e Staff (Padr√£o)
  $('btnNovoProduto').onclick = () => $('formProduto').classList.remove('hidden');
  $('btnSalvarProduto').onclick = () => {
      push(ref(db, 'produtos'), { titulo: $('prodTitulo').value, desc: $('prodDesc').value, valor: $('prodValor').value, link: $('prodLink').value, img: $('prodImg').value });
      $('formProduto').classList.add('hidden');
  };
  onValue(ref(db, 'produtos'), s => {
      $('lojaContainer').innerHTML = Object.entries(s.val()||{}).map(([k,v]) => `<div class="product-card"><img src="${v.img}" class="product-img"><div class="product-body"><div class="product-title">${v.titulo}</div><div class="product-price">${v.valor}</div><a href="${v.link}" target="_blank" class="btn btn-primary">Acessar</a></div>${userSession&&userSession.cargo==='Supervisor'?`<button class="btn-excluir" data-tipo="produtos" data-id="${k}" style="position:absolute;top:5px;right:5px;background:red;border:none;color:white;width:20px;border-radius:50%">X</button>`:''}</div>`).join('') || "Vazio.";
      attachAdminListeners();
  });
  $('staffForm').onsubmit = (e) => { e.preventDefault(); push(ref(db, 'staff'), { nome: $('staffNome').value, whatsapp: $('staffWhats').value, motivo: $('staffMotivo').value }).then(()=>alert("Enviado!")); };
  onValue(ref(db, 'staff'), s => { $('tabelaStaff').innerHTML = Object.entries(s.val()||{}).map(([k,v]) => `<tr><td>${v.nome}</td><td>${v.motivo}</td><td>${userSession&&userSession.cargo==='Supervisor'?`<button class="btn-excluir" data-tipo="staff" data-id="${k}" style="color:red;border:none">X</button>`:''}</td></tr>`).join(''); attachAdminListeners(); });

  $('buscaMembro').onkeyup = () => {
      const t = $('buscaMembro').value.toLowerCase();
      for(let c of $('containerMembros').children) c.style.display = c.innerText.toLowerCase().includes(t) ? "block" : "none";
  };
</script>
</body>
</html>
