<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plataforma UniPsi | Conectada</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<style>
  :root {
    --primary-color: #005b96;
    --secondary-color: #00a896;
    --bg-light: #f4f7f6;
    --text-dark: #333;
    --danger: #e74c3c;
    --success: #2ecc71;
    --warning: #f39c12;
    --info: #3498db;
    --super: #8e44ad;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Roboto', sans-serif; background-color: var(--bg-light); color: var(--text-dark); line-height: 1.6; }

  /* Header */
  header { background: white; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
  .logo-container { display: flex; align-items: center; gap: 15px; }
  .logo-svg { width: 45px; height: 45px; fill: var(--primary-color); }
  .brand-name { font-family: 'Montserrat', sans-serif; font-size: 1.4rem; font-weight: 700; color: var(--primary-color); }
  .brand-tagline { font-size: 0.8rem; color: #666; }

  /* Nav */
  .nav-tabs { display: flex; gap: 5px; margin-top: 1rem; flex-wrap: wrap; }
  .nav-btn { background: none; border: none; padding: 10px 15px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; font-size: 0.9rem; }
  .nav-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
  .nav-btn:hover { color: var(--primary-color); }

  /* Main */
  main { max-width: 1100px; margin: 30px auto; padding: 0 20px; min-height: 75vh; }
  .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); display: none; animation: fadeIn 0.4s ease-in-out; }
  .card.active-view { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Inputs & Forms */
  .form-group { margin-bottom: 15px; }
  label { display: block; margin-bottom: 8px; font-weight: 500; }
  input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; font-family: inherit; }
  input:focus, textarea:focus { outline: none; border-color: var(--primary-color); }

  /* Buttons */
  .btn { padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; width: 100%; transition: 0.2s; text-align: center; text-decoration: none; display: inline-block; }
  .btn-primary { background-color: var(--primary-color); } .btn-primary:hover { background-color: #004a7a; }
  .btn-secondary { background-color: var(--secondary-color); }
  .btn-danger { background-color: var(--danger); width: auto; padding: 8px 16px; }
  .btn-warning { background-color: var(--warning); color:white;}
  .btn-info { background-color: var(--info); color: white; }
  .btn-super { background-color: var(--super); color: white; } 

  /* Badges e Status */
  .badge { padding: 5px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
  .badge-pendente { background: #fff3cd; color: #856404; }
  .badge-aprovado { background: #d4edda; color: #155724; }
  .badge-rejeitado { background: #f8d7da; color: #721c24; }
  .badge-adm { background: #cce5ff; color: #004085; }
  .badge-super { background: #e8daef; color: #5b2c6f; border: 1px solid #d2b4de; }

  /* Rede Social */
  .social-post { border-bottom: 1px solid #eee; padding: 20px 0; }
  .post-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
  .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  .post-author { font-weight: 700; color: var(--primary-color); }
  .post-role { font-size: 0.7rem; color: #888; border:1px solid #eee; padding:2px 6px; border-radius:4px; margin-left:5px;}
  .post-content { margin-bottom: 10px; color: #444; white-space: pre-wrap; }
  .post-actions { display: flex; gap: 15px; }
  .action-btn { background: none; border: none; cursor: pointer; color: #666; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
  .action-btn:hover { color: var(--primary-color); }
  
  .comment-section { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px; display: none; }
  .comment-item { border-bottom: 1px solid #e0e0e0; padding: 5px 0; font-size: 0.9rem; }

  /* Loja / Recursos */
  .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
  .product-card { border: 1px solid #eee; border-radius: 10px; overflow: hidden; background: white; transition: 0.3s; position: relative; }
  .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
  .product-img { width: 100%; height: 150px; object-fit: cover; background: #eee; }
  .product-body { padding: 15px; }
  .product-title { font-weight: 700; margin-bottom: 5px; color: var(--text-dark); }
  .product-price { color: var(--success); font-weight: 700; font-size: 1.1rem; margin-bottom: 10px; }
  .product-desc { font-size: 0.85rem; color: #666; margin-bottom: 15px; height: 40px; overflow: hidden; }

  /* Utilit√°rios */
  .alert { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; text-align: center; }
  .hidden { display: none !important; }
  table { width: 100%; border-collapse: collapse; min-width: 600px; }
  th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
  th { background-color: #f8f9fa; color: var(--primary-color); }
  .table-container { overflow-x: auto; margin-top: 10px; margin-bottom: 30px;}

  footer { text-align: center; padding: 25px; font-size: 0.85rem; color: #888; border-top: 1px solid #eee; margin-top: 40px; }
</style>
</head>
<body oncontextmenu="return false;">

<header>
  <div class="logo-container">
    <svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 2c1.66 0 3 1.34 3 3v3h2V7c0-2.76-2.24-5-5-5S7 4.24 7 7v3h2V7c0-1.66 1.34-3 3-3zm3 11v2h-2v-2h-2v2H9v-2H7v4h10v-4h-2z"/>
    </svg>
    <div>
        <div class="brand-name">Plataforma UniPsi</div>
        <div class="brand-tagline">Conectada em Tempo Real</div>
    </div>
  </div>
  <nav class="nav-tabs">
    <button class="nav-btn active" id="btn-inscricao">Inscri√ß√£o</button>
    <button class="nav-btn" id="btn-social">Comunidade & Rede</button>
    <button class="nav-btn" id="btn-recursos">Recursos & Loja</button>
    <button class="nav-btn" id="btn-staff">Junte-se √† Equipe</button>
    <button class="nav-btn" id="btn-admin">Painel do Gestor</button>
  </nav>
</header>

<main>
  <section id="inscricaoView" class="card active-view">
    <h2>Nova Inscri√ß√£o de Membro</h2>
    <p style="margin-bottom: 20px; font-size: 0.9rem; color: #666;">Preencha seus dados para entrar na nossa rede e ter acesso √† comunidade.</p>
    <div id="formAlert" class="alert"></div>
    
    <form id="inscriptionForm">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group"><label>Nome Completo</label><input type="text" id="nome" required placeholder="Ex: Ana Silva"></div>
          <div class="form-group"><label>E-mail</label><input type="email" id="email" required placeholder="email@exemplo.com"></div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group"><label>WhatsApp</label><input type="text" id="whatsapp" required placeholder="(XX) XXXXX-XXXX"></div>
          <div class="form-group"><label>CRP</label><input type="text" id="crp" placeholder="XX/XXXXX"></div>
      </div>
      <div class="form-group"><label>Abordagem Cl√≠nica</label><input type="text" id="abordagem" placeholder="Ex: TCC, Psican√°lise..."></div>
      <div class="form-group"><label>Especialidades</label><textarea id="especialidades" rows="2" placeholder="Separe por v√≠rgula..."></textarea></div>
      <div class="form-group"><label>Foto de Perfil</label><input type="file" id="fotoFile" accept="image/*"></div>
      <button type="submit" class="btn btn-primary">Enviar para An√°lise (Nuvem)</button>
    </form>
  </section>

  <section id="socialView" class="card">
    <h2>Comunidade UniPsi</h2>
    <p style="color:#666; margin-bottom:20px;">Atualiza√ß√µes em tempo real para todos os profissionais.</p>

    <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:30px; border:1px solid #eee;">
        <h4 style="margin-bottom:10px; color:var(--primary-color);">Criar Publica√ß√£o</h4>
        <div class="form-group">
            <select id="autorPost" style="margin-bottom:10px;">
                <option value="">-- Aguarde carregar membros... --</option>
            </select>
            <textarea id="textoPost" rows="3" placeholder="Divulgue um evento, artigo ou d√∫vida..."></textarea>
        </div>
        <button id="btnPublicar" class="btn btn-secondary" style="width:auto;">Publicar na Rede</button>
    </div>

    <h3 style="border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;">Feed de Atualiza√ß√µes</h3>
    <div id="feedContainer">
      <p style="text-align:center; color:#999;">Carregando feed...</p>
    </div>

    <h3 style="border-bottom:2px solid #eee; padding-bottom:10px; margin:40px 0 20px;">Membros da Rede</h3>
    <input type="text" id="buscaMembro" placeholder="üîç Buscar profissional..." style="margin-bottom:20px;">
    <div class="store-grid" id="containerMembros"></div>
  </section>

  <section id="recursosView" class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Recursos & Loja UniPsi</h2>
        <button id="btnNovoProduto" class="btn btn-super hidden" style="width:auto;">+ Adicionar Produto</button>
    </div>
    <p style="color:#666; margin-bottom:20px;">Materiais exclusivos, Templates HTML e E-books.</p>

    <div id="formProduto" class="hidden" style="background:#f3e5f5; padding:20px; margin-bottom:20px; border-radius:8px;">
        <h4>Cadastrar Novo Produto</h4>
        <div class="form-group"><label>T√≠tulo</label><input type="text" id="prodTitulo"></div>
        <div class="form-group"><label>Descri√ß√£o Curta</label><input type="text" id="prodDesc"></div>
        <div class="form-group"><label>Valor (R$)</label><input type="text" id="prodValor" placeholder="Ex: 29,90 ou Gr√°tis"></div>
        <div class="form-group"><label>Link de Compra/Download</label><input type="text" id="prodLink"></div>
        <div class="form-group"><label>URL da Imagem</label><input type="text" id="prodImg" placeholder="https://..."></div>
        <button id="btnSalvarProduto" class="btn btn-super">Publicar Produto</button>
    </div>

    <div class="store-grid" id="lojaContainer">
       <p>Carregando produtos...</p>
    </div>
  </section>

  <section id="staffRequestView" class="card">
    <h2>Candidatura para Administra√ß√£o</h2>
    <div id="staffAlert" class="alert"></div>
    <form id="staffForm">
        <div class="form-group"><label>Nome</label><input type="text" id="staffNome" required></div>
        <div class="form-group"><label>WhatsApp</label><input type="text" id="staffWhats" required></div>
        <div class="form-group"><label>Motivo</label><textarea id="staffMotivo" required></textarea></div>
        <button type="submit" class="btn btn-warning">Enviar Candidatura</button>
    </form>
  </section>

  <section id="adminView" class="card">
    <div id="adminLogin">
      <h2>Acesso Restrito</h2>
      <div class="form-group">
        <label>Senha de Acesso</label>
        <input type="password" id="senhaAdmin">
      </div>
      <button id="btnLogin" class="btn btn-secondary">Entrar no Painel</button>
    </div>

    <div id="adminDashboard" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:#f1f1f1; padding:15px; border-radius:8px;">
          <div>
              <h3>Painel de Controle</h3>
              <small id="nivelAcesso" class="badge">N√≠vel</small>
          </div>
          <button id="btnLogout" class="btn btn-danger">Sair</button>
      </div>

      <h4 class="admin-section-title">üë§ Gest√£o de Membros</h4>
      <div class="table-container">
        <table>
          <thead><tr><th>Nome</th><th>Status</th><th>Cargo</th><th>A√ß√µes</th></tr></thead>
          <tbody id="tabelaInscritos"></tbody>
        </table>
      </div>

      <h4 class="admin-section-title" style="color:var(--warning)">üõ°Ô∏è Candidatos √† Staff</h4>
      <div class="table-container">
        <table>
            <thead><tr><th>Candidato</th><th>Motivo</th><th>A√ß√µes</th></tr></thead>
            <tbody id="tabelaStaff"></tbody>
          </table>
      </div>
    </div>
  </section>
</main>

<footer>&copy; 2024 Plataforma UniPsi. Desenvolvido por Macs Wellison.</footer>

<script type="module">
  // Importar Firebase SDKs (Vers√£o Modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // --- SUAS CHAVES DO FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyDSDDP98aln1BkuBzDaX7txziAp5CPEpD0",
    authDomain: "unipsi-792b6.firebaseapp.com",
    projectId: "unipsi-792b6",
    storageBucket: "unipsi-792b6.firebasestorage.app",
    messagingSenderId: "44741764168",
    appId: "1:44741764168:web:15ff9121ce50333dbd247d",
    measurementId: "G-HFSTGMGCQ3"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // --- CONFIG GERAL ---
  const CONFIG = {
    hashAdm: "dW5pcHNpX2FkbQ==", 
    hashSuper: "dW5pcHNpX3N1cGVy", 
    linkGrupo: "https://chat.whatsapp.com/K77s3h51A7J6xvJW1TMxmk"
  };

  // --- ESTADO LOCAL (Sess√£o) ---
  let currentUserRole = null; 
  let fotoBase64 = "";

  // --- HELPERS ---
  const $ = (id) => document.getElementById(id);
  function mascaraTelefone(v) { v=v.replace(/\D/g,"");v=v.replace(/^(\d{2})(\d)/g,"($1) $2");v=v.replace(/(\d)(\d{4})$/,"$1-$2"); return v; }
  $('whatsapp').oninput = (e) => e.target.value = mascaraTelefone(e.target.value);
  $('staffWhats').oninput = (e) => e.target.value = mascaraTelefone(e.target.value);
  
  $('fotoFile').addEventListener('change', function(e) {
      const reader = new FileReader();
      reader.onload = function() { fotoBase64 = reader.result; };
      if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
  });

  // --- SISTEMA DE NAVEGA√á√ÉO ---
  function switchView(viewId) {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('active-view'));
      $(viewId).classList.add('active-view');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      
      if(viewId==='inscricaoView') $('btn-inscricao').classList.add('active');
      if(viewId==='socialView') $('btn-social').classList.add('active');
      if(viewId==='recursosView') $('btn-recursos').classList.add('active');
      if(viewId==='staffRequestView') $('btn-staff').classList.add('active');
      if(viewId==='adminView') $('btn-admin').classList.add('active');
  }

  $('btn-inscricao').onclick = () => switchView('inscricaoView');
  $('btn-social').onclick = () => switchView('socialView');
  $('btn-recursos').onclick = () => switchView('recursosView');
  $('btn-staff').onclick = () => switchView('staffRequestView');
  $('btn-admin').onclick = () => switchView('adminView');

  // --- FUN√á√ïES DE ADMINISTRA√á√ÉO (LOGIN) ---
  $('btnLogin').onclick = () => {
      const pass = $('senhaAdmin').value;
      if(btoa(pass) === CONFIG.hashSuper) {
          currentUserRole = 'supervisor';
          $('nivelAcesso').innerText = "SUPERVISOR (Controle Total)";
          $('nivelAcesso').className = "badge badge-super";
      } else if(btoa(pass) === CONFIG.hashAdm) {
          currentUserRole = 'admin';
          $('nivelAcesso').innerText = "ADMINISTRADOR";
          $('nivelAcesso').className = "badge badge-adm";
      } else {
          alert("Senha incorreta."); return;
      }
      $('adminLogin').classList.add('hidden');
      $('adminDashboard').classList.remove('hidden');
      
      // Se for supervisor, libera bot√£o de adicionar produto
      if(currentUserRole === 'supervisor') $('btnNovoProduto').classList.remove('hidden');
      renderAdminTable(); // Re-renderizar para mostrar bot√µes certos
  };

  $('btnLogout').onclick = () => {
      currentUserRole = null;
      $('adminDashboard').classList.add('hidden');
      $('adminLogin').classList.remove('hidden');
      $('senhaAdmin').value = "";
      switchView('inscricaoView');
  };

  // --- L√ìGICA DE DADOS (FIREBASE REALTIME) ---

  // 1. INSCRI√á√ÉO
  $('inscriptionForm').onsubmit = (e) => {
      e.preventDefault();
      const novoMembro = {
          nome: $('nome').value,
          email: $('email').value,
          whatsapp: $('whatsapp').value,
          crp: $('crp').value || "N/A",
          abordagem: $('abordagem').value,
          especialidades: $('especialidades').value.split(','),
          foto: fotoBase64 || "",
          status: "Pendente",
          cargo: "Membro",
          dataCadastro: new Date().toISOString()
      };
      // Enviar para Firebase
      push(ref(db, 'membros'), novoMembro)
        .then(() => {
            alert("‚úÖ Inscri√ß√£o enviada para a nuvem! Aguarde an√°lise.");
            $('inscriptionForm').reset(); fotoBase64 = "";
        })
        .catch(err => alert("Erro ao enviar: " + err.message));
  };

  // 2. ESCUTAR E RENDERIZAR MEMBROS (Admin + Social + Lista)
  // Essa fun√ß√£o roda AUTOMATICAMENTE sempre que algo muda no banco
  onValue(ref(db, 'membros'), (snapshot) => {
      const data = snapshot.val() || {};
      const listaMembros = Object.entries(data).map(([key, val]) => ({ ...val, id: key })); // Converte Objeto em Array
      
      // A. Atualizar Tabela Admin
      const tbM = $('tabelaInscritos');
      tbM.innerHTML = "";
      listaMembros.reverse().forEach(p => {
          let acoes = "";
          // Bot√µes Admin
          if(currentUserRole) {
              if(p.status === 'Pendente') {
                 // Usando atributo data-id para capturar clique depois
                 acoes += `<button class="btn-primary btn-aprovar" data-id="${p.id}" data-nome="${p.nome}" data-tel="${p.whatsapp}" style="padding:4px 8px; font-size:0.7rem; margin-right:5px;">Aprovar</button>`;
                 acoes += `<button class="btn-danger btn-reprovar" data-id="${p.id}" data-nome="${p.nome}" data-tel="${p.whatsapp}" style="padding:4px 8px; font-size:0.7rem;">Reprovar</button>`;
              } else if (currentUserRole === 'supervisor') {
                 acoes += `<button class="btn-info btn-promover" data-id="${p.id}" style="padding:4px; font-size:0.7rem; margin-right:5px;">‚¨ÜÔ∏è Cargo</button>`;
                 acoes += `<button class="btn-danger btn-excluir" data-id="${p.id}" data-tipo="membros" style="padding:4px; font-size:0.7rem;">üóëÔ∏è</button>`;
              }
          }
          let badgeClass = p.status==='Aprovado'?'badge-aprovado':(p.status==='Rejeitado'?'badge-rejeitado':'badge-pendente');
          tbM.innerHTML += `<tr>
              <td><strong>${p.nome}</strong><br><small>${p.email}</small></td>
              <td><span class="badge ${badgeClass}">${p.status}</span></td>
              <td><span class="badge badge-adm">${p.cargo}</span></td>
              <td>${acoes}</td>
          </tr>`;
      });
      attachAdminEvents(); // Reconectar eventos nos bot√µes novos

      // B. Atualizar Select de Postagem
      const select = $('autorPost');
      select.innerHTML = '<option value="">-- Quem √© voc√™? --</option>';
      const membrosAprovados = listaMembros.filter(m => m.status === 'Aprovado');
      membrosAprovados.forEach(m => {
          select.innerHTML += `<option value="${m.nome}|${m.cargo}|${m.foto}">${m.nome} (${m.cargo})</option>`;
      });

      // C. Atualizar Lista Visual de Membros (Aba Comunidade)
      const grid = $('containerMembros');
      grid.innerHTML = "";
      membrosAprovados.forEach(p => {
          grid.innerHTML += `
          <div class="product-card" style="padding:15px; text-align:center;">
             <img src="${p.foto || 'https://via.placeholder.com/80'}" style="width:70px; height:70px; border-radius:50%; object-fit:cover; margin:0 auto 10px;">
             <div style="font-weight:bold; color:var(--primary-color)">${p.nome}</div>
             <div style="font-size:0.8rem; margin-bottom:10px;">${p.especialidades ? p.especialidades[0] : 'Psicologia'}</div>
             <a href="https://wa.me/55${p.whatsapp.replace(/\D/g,'')}" target="_blank" class="btn btn-secondary" style="padding:5px; font-size:0.8rem;">Conversar</a>
          </div>`;
      });
  });

  // 3. EVENTOS DE ADMINISTRA√á√ÉO (Delegate manual para elementos din√¢micos)
  function attachAdminEvents() {
      // Aprovar
      document.querySelectorAll('.btn-aprovar').forEach(btn => {
          btn.onclick = () => {
              update(ref(db, 'membros/' + btn.dataset.id), { status: 'Aprovado' });
              enviarFeedbackWhats(btn.dataset.nome, btn.dataset.tel, 'Aprovado');
          }
      });
      // Reprovar
      document.querySelectorAll('.btn-reprovar').forEach(btn => {
          btn.onclick = () => {
              update(ref(db, 'membros/' + btn.dataset.id), { status: 'Rejeitado' });
              enviarFeedbackWhats(btn.dataset.nome, btn.dataset.tel, 'Rejeitado');
          }
      });
      // Excluir
      document.querySelectorAll('.btn-excluir').forEach(btn => {
          btn.onclick = () => {
              if(confirm("Excluir item definitivamente?")) remove(ref(db, btn.dataset.tipo + '/' + btn.dataset.id));
          }
      });
      // Promover
      document.querySelectorAll('.btn-promover').forEach(btn => {
          btn.onclick = () => {
              const novoCargo = prompt("Novo cargo (Admin, Supervisor, Membro):");
              if(novoCargo) update(ref(db, 'membros/' + btn.dataset.id), { cargo: novoCargo });
          }
      });
  }

  // Renderizar Admin Table ao fazer login tamb√©m (para garantir bot√µes certos)
  function renderAdminTable() {
      // For√ßa um "refresh" pegando o estado atual, mas o listener j√° cuida disso
  }

  function enviarFeedbackWhats(nome, tel, status) {
      const pNome = nome.split(" ")[0];
      const fone = "55" + tel.replace(/\D/g,'');
      let msg = "";
      if(status === 'Aprovado') {
          msg = `Ol√°, ${pNome}! ‚ú®\n\nSua inscri√ß√£o na *Plataforma UniPsi* foi APROVADA! üéâ\n\nAgora voc√™ aparece na nossa lista oficial de profissionais.\nüëâ *Entre no grupo:* ${CONFIG.linkGrupo}`;
      } else {
          msg = `Ol√°, ${pNome}. Agradecemos o interesse na UniPsi, mas sua inscri√ß√£o n√£o p√¥de ser aprovada no momento.`;
      }
      window.open(`https://wa.me/${fone}?text=${encodeURIComponent(msg)}`, '_blank');
  }

  // 4. POSTS & SOCIAL (Nuvem)
  $('btnPublicar').onclick = () => {
      const autorDados = $('autorPost').value;
      const texto = $('textoPost').value;
      if(!autorDados || !texto) { alert("Selecione seu perfil e escreva algo."); return; }
      
      const [nome, cargo, foto] = autorDados.split('|');
      push(ref(db, 'posts'), {
          autor: nome,
          cargo: cargo,
          fotoAutor: foto,
          texto: texto,
          data: new Date().toLocaleString('pt-BR'),
          likes: 0
      });
      $('textoPost').value = "";
  };

  // Escutar Posts
  onValue(ref(db, 'posts'), (snapshot) => {
      const data = snapshot.val() || {};
      const feed = $('feedContainer');
      feed.innerHTML = "";
      
      const posts = Object.entries(data).map(([k, v]) => ({...v, id: k})).reverse();
      
      if(posts.length === 0) feed.innerHTML = "<p style='text-align:center; padding:20px;'>Nenhum post ainda.</p>";

      posts.forEach(post => {
          // Coment√°rios (array no firebase)
          const comentarios = post.comentarios ? Object.values(post.comentarios) : [];
          let htmlComents = comentarios.map(c => `<div class="comment-item"><strong>${c.autor}:</strong> ${c.texto}</div>`).join('');

          let btnDelete = (currentUserRole === 'supervisor') ? `<button class="action-btn btn-del-post" data-id="${post.id}" style="color:red">üóëÔ∏è</button>` : '';

          feed.innerHTML += `
          <div class="social-post">
              <div class="post-header">
                  <img src="${post.fotoAutor || 'https://via.placeholder.com/40'}" class="post-avatar">
                  <div>
                      <span class="post-author">${post.autor}</span>
                      <span class="post-role">${post.cargo}</span>
                      <div style="font-size:0.75rem; color:#999">${post.data}</div>
                  </div>
              </div>
              <div class="post-content">${post.texto}</div>
              <div class="post-actions">
                  <button class="action-btn btn-like" data-id="${post.id}" data-likes="${post.likes}">‚ù§Ô∏è ${post.likes}</button>
                  <button class="action-btn" onclick="document.getElementById('comment-box-${post.id}').style.display='block'">üí¨ Comentar</button>
                  ${btnDelete}
              </div>
              <div id="comment-box-${post.id}" class="comment-section">
                  <div style="margin-bottom:10px; max-height:100px; overflow-y:auto;">${htmlComents}</div>
                  <input type="text" id="input-c-${post.id}" placeholder="Escreva..." style="font-size:0.9rem; padding:8px; width:70%">
                  <button class="btn-primary btn-send-comment" data-id="${post.id}" style="width:25%; padding:5px;">Enviar</button>
              </div>
          </div>`;
      });

      // Attach events for posts (Likes, Comments, Delete)
      document.querySelectorAll('.btn-like').forEach(b => {
          b.onclick = () => {
              const current = parseInt(b.dataset.likes);
              update(ref(db, 'posts/' + b.dataset.id), { likes: current + 1 });
          }
      });
      document.querySelectorAll('.btn-del-post').forEach(b => {
          b.onclick = () => {
              if(confirm("Apagar post?")) remove(ref(db, 'posts/' + b.dataset.id));
          }
      });
      document.querySelectorAll('.btn-send-comment').forEach(b => {
          b.onclick = () => {
              const id = b.dataset.id;
              const txt = document.getElementById('input-c-'+id).value;
              if(!txt) return;
              
              let autorNome = "Colega UniPsi";
              const autorSelect = $('autorPost').value;
              if(autorSelect) autorNome = autorSelect.split('|')[0];

              push(ref(db, `posts/${id}/comentarios`), { autor: autorNome, texto: txt });
          }
      });
  });

  // 5. LOJA & PRODUTOS (Nuvem)
  $('btnNovoProduto').onclick = () => $('formProduto').classList.remove('hidden');
  
  $('btnSalvarProduto').onclick = () => {
      push(ref(db, 'produtos'), {
          titulo: $('prodTitulo').value,
          desc: $('prodDesc').value,
          valor: $('prodValor').value,
          link: $('prodLink').value,
          img: $('prodImg').value
      });
      $('formProduto').classList.add('hidden');
      $('prodTitulo').value = ""; // Clear simples
  };

  onValue(ref(db, 'produtos'), (snapshot) => {
      const container = $('lojaContainer');
      container.innerHTML = "";
      const data = snapshot.val() || {};
      const prods = Object.entries(data).map(([k,v]) => ({...v, id:k}));

      if(prods.length === 0) container.innerHTML = "<p>Em breve novidades.</p>";

      prods.forEach(prod => {
          let btnDelete = (currentUserRole === 'supervisor') ? 
             `<button class="btn-excluir" data-tipo="produtos" data-id="${prod.id}" style="position:absolute; top:10px; right:10px; background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer;">X</button>` : '';
          
          container.innerHTML += `
          <div class="product-card">
              ${btnDelete}
              <img src="${prod.img || 'https://via.placeholder.com/300x150?text=Recurso'}" class="product-img">
              <div class="product-body">
                  <div class="product-title">${prod.titulo}</div>
                  <div class="product-desc">${prod.desc}</div>
                  <div class="product-price">${prod.valor}</div>
                  <a href="${prod.link}" target="_blank" class="btn btn-primary">Acessar</a>
              </div>
          </div>`;
      });
      attachAdminEvents(); // Para reconectar o bot√£o excluir da loja
  });

  // 6. STAFF REQUESTS
  $('staffForm').onsubmit = (e) => {
      e.preventDefault();
      push(ref(db, 'staff'), {
          nome: $('staffNome').value,
          whatsapp: $('staffWhats').value,
          motivo: $('staffMotivo').value
      }).then(() => { alert("Candidatura enviada!"); $('staffForm').reset(); });
  };

  onValue(ref(db, 'staff'), (snapshot) => {
      const tbS = $('tabelaStaff');
      tbS.innerHTML = "";
      const data = snapshot.val() || {};
      Object.entries(data).forEach(([key, s]) => {
         let acoes = `<a href="https://wa.me/55${s.whatsapp.replace(/\D/g,'')}" target="_blank">üìû Whats</a> `;
         if(currentUserRole === 'supervisor') {
             acoes += ` | <button class="btn-excluir" data-tipo="staff" data-id="${key}" style="color:red; border:none; cursor:pointer;">X</button>`;
         }
         tbS.innerHTML += `<tr><td>${s.nome}</td><td><small>${s.motivo}</small></td><td>${acoes}</td></tr>`;
      });
      attachAdminEvents();
  });

  // Filtro de Busca de Membros
  $('buscaMembro').onkeyup = () => {
      const termo = $('buscaMembro').value.toLowerCase();
      const cards = $('containerMembros').children;
      for(let c of cards) {
          c.style.display = c.innerText.toLowerCase().includes(termo) ? "block" : "none";
      }
  };

</script>
</body>
</html>